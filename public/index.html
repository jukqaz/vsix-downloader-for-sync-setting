<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VSX 확장 프로그램 찾기</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
      padding-top: 2rem;
      padding-bottom: 2rem;
    }
    .header {
      padding-bottom: 2rem;
      border-bottom: 1px solid #e5e5e5;
      margin-bottom: 2rem;
    }
    .extension-item {
      padding: 1rem;
      margin-bottom: 0.5rem;
      border-radius: 0.25rem;
      transition: all 0.2s;
    }
    .extension-item:hover {
      background-color: #f8f9fa;
    }
    .badge {
      font-size: 0.8rem;
    }
    .search-container {
      margin-bottom: 2rem;
    }
    .tab-content {
      padding-top: 1rem;
    }
    .spinner-border {
      width: 1rem;
      height: 1rem;
      margin-right: 0.5rem;
    }
    .download-btn {
      min-width: 120px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header text-center">
      <h1>VSX 확장 프로그램 찾기</h1>
      <p class="lead">VSCode 확장 프로그램을 Open VSX에서 검색하고 VSIX 파일을 다운로드하는 도구</p>
    </div>

    <div class="search-container">
      <div class="row">
        <div class="col-md-8 offset-md-2">
          <div class="card mb-4">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">extensions.yml 파일 업로드</h5>
            </div>
            <div class="card-body">
              <form id="upload-form" enctype="multipart/form-data">
                <div class="mb-3">
                  <label for="extensions-file" class="form-label">VS Code extensions.yml 파일 선택</label>
                  <input class="form-control" type="file" id="extensions-file" name="extensionsFile" accept=".yml,.yaml">
                </div>
                <button type="submit" class="btn btn-primary" id="upload-btn">업로드 및 분석</button>
              </form>
              <div id="upload-status" class="mt-3 d-none">
                <div class="d-flex align-items-center">
                  <div class="spinner-border text-primary me-2" role="status">
                    <span class="visually-hidden">로딩 중...</span>
                  </div>
                  <span>파일 분석 중...</span>
                </div>
              </div>
            </div>
          </div>

          <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
              <h5 class="mb-0">개별 확장 프로그램 검색</h5>
            </div>
            <div class="card-body">
              <div class="input-group mb-3">
                <input type="text" id="search-input" class="form-control" placeholder="확장 프로그램 ID 검색 (예: ms-python.python)">
                <button class="btn btn-primary" id="search-btn">검색</button>
              </div>
              
              <div class="input-group">
                <input type="text" id="uuid-input" class="form-control" placeholder="UUID로 검색 (예: f1f59ae4-9318-4f3c-a9b5-81b2eaa5f8a5)">
                <button class="btn btn-secondary" id="uuid-search-btn">UUID로 검색</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <ul class="nav nav-tabs" id="extensionTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="unavailable-tab" data-bs-toggle="tab" data-bs-target="#unavailable" type="button" role="tab">
          사용할 수 없는 확장 프로그램
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="available-tab" data-bs-toggle="tab" data-bs-target="#available" type="button" role="tab">
          사용 가능한 확장 프로그램
        </button>
      </li>
    </ul>

    <div class="tab-content" id="extensionTabsContent">
      <div class="tab-pane fade show active" id="unavailable" role="tabpanel">
        <div class="alert alert-warning">
          아래 확장 프로그램들은 Open VSX에서 사용할 수 없습니다. VSIX 파일을 다운로드하여 수동으로 설치해야 합니다.
        </div>
        <div id="unavailable-list" class="list-group">
          <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
              <span class="visually-hidden">로딩 중...</span>
            </div>
            <p class="mt-3">확장 프로그램 목록을 불러오는 중...</p>
          </div>
        </div>
      </div>
      
      <div class="tab-pane fade" id="available" role="tabpanel">
        <div class="alert alert-success">
          아래 확장 프로그램들은 Open VSX에서 사용 가능합니다.
        </div>
        <div id="available-list" class="list-group">
          <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
              <span class="visually-hidden">로딩 중...</span>
            </div>
            <p class="mt-3">확장 프로그램 목록을 불러오는 중...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="mt-5">
      <h3>사용 방법</h3>
      <ol>
        <li>VS Code에서 <code>extensions.yml</code> 파일을 내보냅니다.</li>
        <li>웹 인터페이스에서 <code>extensions.yml</code> 파일을 업로드합니다.</li>
        <li>Open VSX에서 사용할 수 없는 확장 프로그램 목록이 표시됩니다.</li>
        <li>웹 인터페이스에서 ID 또는 UUID로 확장 프로그램을 검색하고 다운로드할 수 있습니다.</li>
        <li>다운로드한 VSIX 파일을 Open VSX 기반 IDE에 수동으로 설치합니다.</li>
      </ol>
      
      <h3>VS Code에서 extensions.yml 파일 내보내기</h3>
      <p>VS Code에서 다음 명령을 실행하여 확장 프로그램 목록을 YAML 형식으로 내보낼 수 있습니다:</p>
      <pre><code>code --list-extensions --show-versions | sed -e 's/\(.*\)@\(.*\)/  - id: \1\n    uuid: 00000000-0000-0000-0000-000000000000/' | (echo "enabled:" && cat) > extensions.yml</code></pre>
      <p>이후 각 확장 프로그램의 UUID를 수동으로 업데이트해야 합니다.</p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      fetchExtensions();
      
      // 검색 기능 이벤트 리스너
      document.getElementById('search-btn').addEventListener('click', searchExtension);
      document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          searchExtension();
        }
      });
      
      document.getElementById('uuid-search-btn').addEventListener('click', searchByUuid);
      document.getElementById('uuid-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          searchByUuid();
        }
      });
      
      // 파일 업로드 이벤트 리스너
      document.getElementById('upload-form').addEventListener('submit', function(e) {
        e.preventDefault();
        uploadExtensionsFile();
      });
    });
    
    // extensions.yml 파일 업로드 및 처리 함수
    function uploadExtensionsFile() {
      const fileInput = document.getElementById('extensions-file');
      const uploadStatus = document.getElementById('upload-status');
      const uploadBtn = document.getElementById('upload-btn');
      
      if (!fileInput.files || fileInput.files.length === 0) {
        alert('extensions.yml 파일을 선택해주세요.');
        return;
      }
      
      const file = fileInput.files[0];
      const formData = new FormData();
      formData.append('extensionsFile', file);
      
      // 업로드 상태 표시
      uploadStatus.classList.remove('d-none');
      uploadBtn.disabled = true;
      
      fetch('/api/upload', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          uploadStatus.innerHTML = '<div class="alert alert-success">파일 분석 완료! 확장 프로그램 목록이 업데이트되었습니다.</div>';
          // 확장 프로그램 목록 새로고침
          fetchExtensions();
        } else {
          uploadStatus.innerHTML = `<div class="alert alert-danger">파일 분석 실패: ${data.message}</div>`;
        }
      })
      .catch(error => {
        uploadStatus.innerHTML = `<div class="alert alert-danger">오류 발생: ${error.message}</div>`;
      })
      .finally(() => {
        uploadBtn.disabled = false;
      });
    }

    function fetchExtensions() {
      fetch('/api/extensions')
        .then(response => response.json())
        .then(data => {
          renderExtensionList(data.available, 'available-list');
          renderExtensionList(data.unavailable, 'unavailable-list');
        })
        .catch(error => {
          document.getElementById('unavailable-list').innerHTML = `
            <div class="alert alert-danger">
              확장 프로그램 목록을 불러오는 중 오류가 발생했습니다: ${error.message}
            </div>
          `;
          document.getElementById('available-list').innerHTML = `
            <div class="alert alert-danger">
              확장 프로그램 목록을 불러오는 중 오류가 발생했습니다: ${error.message}
            </div>
          `;
        });
    }

    function renderExtensionList(extensions, containerId) {
      const container = document.getElementById(containerId);
      
      if (!extensions || extensions.length === 0) {
        container.innerHTML = '<div class="alert alert-info">확장 프로그램이 없습니다.</div>';
        return;
      }
      
      let html = '';
      
      extensions.forEach(extension => {
        html += `
          <div class="extension-item list-group-item list-group-item-action">
            <div class="d-flex w-100 justify-content-between align-items-center">
              <h5 class="mb-1">${extension.id}</h5>
              <div>
                ${containerId === 'unavailable-list' ? 
                  `<div class="btn-group">
                    <button class="btn btn-primary download-btn" onclick="downloadExtension('${extension.id}', this)">
                      <span class="download-text">ID로 다운로드</span>
                    </button>
                    ${extension.uuid ? 
                      `<button class="btn btn-outline-primary download-btn" onclick="downloadExtensionByUuid('${extension.uuid}', this)">
                        <span class="download-text">UUID로 다운로드</span>
                      </button>` : 
                      ''
                    }
                  </div>` : 
                  `<span class="badge bg-success">Open VSX에서 사용 가능</span>`
                }
              </div>
            </div>
            <p class="mb-1">UUID: ${extension.uuid || '없음'}</p>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    function downloadExtension(extensionId, button) {
      const downloadText = button.querySelector('.download-text');
      const originalText = downloadText.textContent;
      
      downloadText.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 다운로드 중...';
      button.disabled = true;
      
      fetch(`/api/download/${extensionId}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // VSCode Marketplace에서 다운로드
            if (data.directDownloadUrl) {
              downloadText.textContent = '직접 다운로드 완료';
              button.classList.remove('btn-primary');
              button.classList.add('btn-success');
              
              // 직접 다운로드 링크 생성
              const link = document.createElement('a');
              link.href = data.directDownloadUrl;
              // 서버에서 전달한 파일 이름 사용
              link.download = data.fileName || `${extensionId}.vsix`;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
            } else {
              downloadText.textContent = '다운로드 실패';
              button.classList.remove('btn-primary');
              button.classList.add('btn-danger');
            }
          } else {
            downloadText.textContent = '다운로드 실패';
            button.classList.remove('btn-primary');
            button.classList.add('btn-danger');
            alert(`다운로드 실패: ${data.error || '알 수 없는 오류'}`);
          }
        })
        .catch(error => {
          downloadText.textContent = '다운로드 실패';
          button.classList.remove('btn-primary');
          button.classList.add('btn-danger');
          alert(`다운로드 실패: ${error.message}`);
        })
        .finally(() => {
          button.disabled = false;
        });
    }
    
    function downloadExtensionByUuid(uuid, button) {
      const downloadText = button.querySelector('.download-text');
      const originalText = downloadText.textContent;
      
      downloadText.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 다운로드 중...';
      button.disabled = true;
      
      fetch(`/api/download-by-uuid/${uuid}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // VSCode Marketplace에서 다운로드
            if (data.directDownloadUrl) {
              downloadText.textContent = '직접 다운로드 완료';
              button.classList.remove('btn-outline-primary');
              button.classList.add('btn-success');
              
              // 직접 다운로드 링크 생성
              const link = document.createElement('a');
              link.href = data.directDownloadUrl;
              // 서버에서 전달한 파일 이름 사용
              link.download = data.fileName || `${uuid}.vsix`;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
            } else {
              downloadText.textContent = '다운로드 실패';
              button.classList.remove('btn-outline-primary');
              button.classList.add('btn-danger');
            }
          } else {
            downloadText.textContent = '다운로드 실패';
            button.classList.remove('btn-outline-primary');
            button.classList.add('btn-danger');
            alert(`다운로드 실패: ${data.error || '알 수 없는 오류'}`);
          }
        })
        .catch(error => {
          downloadText.textContent = '다운로드 실패';
          button.classList.remove('btn-outline-primary');
          button.classList.add('btn-danger');
          alert(`다운로드 실패: ${error.message}`);
        })
        .finally(() => {
          button.disabled = false;
        });
    }

    function searchExtension() {
      const searchInput = document.getElementById('search-input');
      const extensionId = searchInput.value.trim();
      
      if (!extensionId) {
        alert('확장 프로그램 ID를 입력하세요.');
        return;
      }
      
      // 모든 확장 프로그램 항목 숨기기
      document.querySelectorAll('.extension-item').forEach(item => {
        item.style.display = 'none';
      });
      
      // 검색어와 일치하는 항목만 표시
      document.querySelectorAll('.extension-item').forEach(item => {
        const id = item.querySelector('h5').textContent;
        if (id.toLowerCase().includes(extensionId.toLowerCase())) {
          item.style.display = 'block';
        }
      });
    }
    
    function searchByUuid() {
      const uuidInput = document.getElementById('uuid-input');
      const uuid = uuidInput.value.trim();
      
      if (!uuid) {
        alert('UUID를 입력하세요.');
        return;
      }
      
      // 모든 확장 프로그램 항목 숨기기
      document.querySelectorAll('.extension-item').forEach(item => {
        item.style.display = 'none';
      });
      
      // UUID와 일치하는 항목만 표시
      let found = false;
      document.querySelectorAll('.extension-item').forEach(item => {
        const itemUuid = item.querySelector('p').textContent.replace('UUID: ', '');
        if (itemUuid.toLowerCase().includes(uuid.toLowerCase())) {
          item.style.display = 'block';
          found = true;
        }
      });
      
      if (!found) {
        alert(`UUID ${uuid}에 해당하는 확장 프로그램을 찾을 수 없습니다.`);
      }
    }
  </script>
</body>
</html>
